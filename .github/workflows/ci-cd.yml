# Pipeline de CI/CD
# Executa build, testes, análise de código e deploy simulado

name: CI/CD Pipeline

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  SERVICE_NAME: 'pagamento-service'
  SERVICE_PORT: '5003'

jobs:
  # CI - Integração Contínua

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restaurar dependências
        run: dotnet restore

      - name: Compilar
        run: dotnet build --configuration Release --no-restore

  test-unit:
    name: Testes Unitários
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restaurar dependências
        run: dotnet restore

      - name: Executar testes unitários com cobertura
        run: |
          dotnet test Tests.Unit/Tests.Unit.csproj \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage/unit \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      - name: Upload cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit
          path: coverage/unit/**/coverage.opencover.xml

  test-bdd:
    name: Testes BDD
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restaurar dependências
        run: dotnet restore

      - name: Executar testes BDD
        run: |
          dotnet test Tests.BDD/Tests.BDD.csproj \
            --configuration Release \
            --verbosity normal \
            --logger "trx;LogFileName=bdd-results.trx"

      - name: Upload resultados BDD
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bdd-test-results
          path: Tests.BDD/TestResults/*.trx

  sonarcloud:
    name: Análise SonarCloud
    runs-on: ubuntu-latest
    needs: [test-unit, test-bdd]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Instalar SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Instalar ferramenta de cobertura
        run: dotnet tool install --global dotnet-coverage

      - name: Download cobertura
        uses: actions/download-artifact@v4
        with:
          name: coverage-unit
          path: coverage

      - name: Localizar arquivo de cobertura
        id: coverage
        run: |
          COVERAGE_FILE=$(find coverage -name "coverage.opencover.xml" | head -1)
          echo "file=$COVERAGE_FILE" >> $GITHUB_OUTPUT

      - name: Iniciar análise SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner begin \
            /k:"${{ secrets.SONAR_PROJECT_KEY }}" \
            /o:"${{ secrets.SONAR_ORGANIZATION }}" \
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.opencover.reportsPaths="${{ steps.coverage.outputs.file }}" \
            /d:sonar.coverage.exclusions="**/Migrations/**,**/Program.cs,**/obj/**,**/bin/**,**/Consumers/**,**/Persistence/**,**/ExternalServices/**,**/DTOs/**" \
            /d:sonar.exclusions="**/Migrations/**,**/obj/**,**/bin/**" \
            /d:sonar.sources="Api,Core,Infrastructure" \
            /d:sonar.tests="Tests.Unit,Tests.BDD"

      - name: Compilar para SonarCloud
        run: dotnet build --configuration Release

      - name: Finalizar análise SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.qualitygate.wait=true

  security-scan:
    name: Verificação de Segurança
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restaurar dependências
        run: dotnet restore

      - name: Verificar pacotes vulneráveis
        run: |
          dotnet list package --vulnerable --include-transitive 2>&1 | tee security-report.txt
          if grep -q "has the following vulnerable packages" security-report.txt; then
            echo "::warning::Pacotes vulneráveis detectados. Verifique o relatório."
          fi

      - name: Upload relatório de segurança
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.txt

  # CD - Deploy Contínuo (apenas push para main)

  build-docker:
    name: Build Docker
    runs-on: ubuntu-latest
    needs: [test-unit, test-bdd, security-scan, sonarcloud]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build imagem Docker
        run: |
          echo "Serviço: ${{ env.SERVICE_NAME }}"
          echo "Tags: ${{ env.SERVICE_NAME }}:${{ github.sha }}, ${{ env.SERVICE_NAME }}:latest"

          docker build -t ${{ env.SERVICE_NAME }}:${{ github.sha }} \
                       -t ${{ env.SERVICE_NAME }}:latest \
                       -f Dockerfile .

          docker images | grep ${{ env.SERVICE_NAME }}

      - name: Testar imagem Docker
        run: |
          echo "Iniciando container para health check..."

          docker run -d --name test-container \
            -p 8080:8080 \
            -e ASPNETCORE_ENVIRONMENT=Development \
            ${{ env.SERVICE_NAME }}:latest

          sleep 10

          if docker ps | grep -q test-container; then
            echo "Container rodando com sucesso"
            docker logs test-container
          else
            echo "Falha ao iniciar container"
            docker logs test-container
            exit 1
          fi

          docker stop test-container && docker rm test-container

  deploy-simulated:
    name: Deploy Simulado
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Simular push para registry
        run: |
          echo "Em um deploy real, este passo faria:"
          echo "  - Login no Docker Registry (ECR, Docker Hub, etc.)"
          echo "  - Tag da imagem com URL do registry"
          echo "  - Push da imagem para o registry"

      - name: Simular deploy Kubernetes/ECS
        run: |
          echo "Informações do deploy:"
          echo "  Serviço: ${{ env.SERVICE_NAME }}"
          echo "  Porta: ${{ env.SERVICE_PORT }}"
          echo "  Tag: ${{ github.sha }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo "  Autor: ${{ github.actor }}"
          echo "  Data: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

      - name: Resumo do Deploy
        run: |
          echo "Deploy concluído com sucesso!"
          echo "Serviço: ${{ env.SERVICE_NAME }}"
          echo "Versão: ${{ github.sha }}"
