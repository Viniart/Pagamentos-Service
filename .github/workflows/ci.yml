# Pipeline de integração contínua
# Executa build, testes e análise de código em PRs e pushes para main

name: CI - Build, Test & SonarCloud

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restaurar dependências
        run: dotnet restore

      - name: Compilar
        run: dotnet build --configuration Release --no-restore

  test-unit:
    name: Testes Unitários
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restaurar dependências
        run: dotnet restore

      - name: Executar testes unitários com cobertura
        run: |
          dotnet test Tests.Unit/Tests.Unit.csproj \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./coverage/unit \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      - name: Upload cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit
          path: coverage/unit/**/coverage.opencover.xml

  test-bdd:
    name: Testes BDD
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restaurar dependências
        run: dotnet restore

      - name: Executar testes BDD
        run: |
          dotnet test Tests.BDD/Tests.BDD.csproj \
            --configuration Release \
            --verbosity normal \
            --logger "trx;LogFileName=bdd-results.trx"

      - name: Upload resultados BDD
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bdd-test-results
          path: Tests.BDD/TestResults/*.trx

  sonarcloud:
    name: Análise SonarCloud
    runs-on: ubuntu-latest
    needs: [test-unit, test-bdd]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Instalar SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Instalar ferramenta de cobertura
        run: dotnet tool install --global dotnet-coverage

      - name: Download cobertura
        uses: actions/download-artifact@v4
        with:
          name: coverage-unit
          path: coverage

      - name: Localizar arquivo de cobertura
        id: coverage
        run: |
          COVERAGE_FILE=$(find coverage -name "coverage.opencover.xml" | head -1)
          echo "file=$COVERAGE_FILE" >> $GITHUB_OUTPUT

      - name: Iniciar análise SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner begin \
            /k:"${{ secrets.SONAR_PROJECT_KEY }}" \
            /o:"${{ secrets.SONAR_ORGANIZATION }}" \
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.opencover.reportsPaths="${{ steps.coverage.outputs.file }}" \
            /d:sonar.coverage.exclusions="**/Migrations/**,**/Program.cs,**/obj/**,**/bin/**,**/Consumers/**" \
            /d:sonar.exclusions="**/Migrations/**,**/obj/**,**/bin/**" \
            /d:sonar.sources="Api,Core,Infrastructure" \
            /d:sonar.tests="Tests.Unit,Tests.BDD"

      - name: Compilar para SonarCloud
        run: dotnet build --configuration Release

      - name: Finalizar análise SonarCloud
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

  security-scan:
    name: Verificação de Segurança
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restaurar dependências
        run: dotnet restore

      - name: Verificar pacotes vulneráveis
        run: |
          dotnet list package --vulnerable --include-transitive 2>&1 | tee security-report.txt
          if grep -q "has the following vulnerable packages" security-report.txt; then
            echo "::warning::Pacotes vulneráveis detectados. Verifique o relatório."
          fi

      - name: Upload relatório de segurança
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.txt
